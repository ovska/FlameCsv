// <auto-generated>
// ReSharper disable All
using System.Buffers;

namespace FlameCsv.Benchmark.Utils;

internal class MemorySegment<T> : ReadOnlySequenceSegment<T>
{
    public MemorySegment(ReadOnlyMemory<T> memory)
    {
        Memory = memory;
    }

    public MemorySegment<T> Append(ReadOnlyMemory<T> memory)
    {
        var segment = new MemorySegment<T>(memory)
        {
            RunningIndex = RunningIndex + Memory.Length,
        };

        Next = segment;

        return segment;
    }

    public static ReadOnlySequence<T> AsSequence(
        ReadOnlyMemory<T> data,
        int bufferSize,
        int emptyFrequency = 0)
    {
        ArgumentOutOfRangeException.ThrowIfNegative(emptyFrequency);

        if (bufferSize == -1 || data.Length <= bufferSize)
            return new ReadOnlySequence<T>(data);

        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(bufferSize);

        MemorySegment<T> first = new(data.Slice(0, bufferSize));
        MemorySegment<T> last = first;

        ReadOnlyMemory<T> remaining = data.Slice(bufferSize);

        int counter = 0;

        while (remaining.Length > bufferSize)
        {
            last = last.Append(remaining.Slice(0, bufferSize));
            remaining = remaining.Slice(bufferSize);

            if (emptyFrequency > 0 && ++counter % emptyFrequency == 0)
                last = last.Append(ReadOnlyMemory<T>.Empty);
        }

        last = last.Append(remaining);
        return new(first, 0, last, last.Memory.Length);
    }
}

