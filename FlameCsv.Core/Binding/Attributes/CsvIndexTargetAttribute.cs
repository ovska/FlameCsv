using CommunityToolkit.Diagnostics;
using FlameCsv.Extensions;

namespace FlameCsv.Binding.Attributes;

/// <summary>
/// Binds <see cref="MemberName"/> to CSV column at <see cref="Index"/>.
/// Can be used when <see cref="CsvIndexAttribute"/> cannot be used, e.g. on autogenerated partial classes.
/// </summary>
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Struct, AllowMultiple = true)]
public sealed class CsvIndexTargetAttribute : Attribute
{
    /// <summary>CSV column index.</summary>
    public int Index { get; }

    /// <summary>Name of the property or field.</summary>
    public string MemberName { get; }

    /// <inheritdoc cref="CsvIndexTargetAttribute"/>
    /// <param name="index">CSV column index</param>
    /// <param name="memberName">Name of the property or field</param>
    public CsvIndexTargetAttribute(
        int index,
        string memberName)
    {
        Guard.IsGreaterThanOrEqualTo(index, 0);
        Guard.IsNotNullOrWhiteSpace(memberName);
        Index = index;
        MemberName = memberName;
    }

    internal CsvBinding GetAsBinding(Type targetType)
    {
        Guard.IsNotNull(targetType);
        GuardEx.IsNotInterface(targetType);
        return CsvBinding.ForMember(Index, targetType.GetPropertyOrField(MemberName));
    }
}
