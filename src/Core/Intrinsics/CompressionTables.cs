using System.Diagnostics;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Runtime.Intrinsics;

namespace FlameCsv.Intrinsics;

/// <summary>
/// Sources for ThinEpi8/PopCountMult2/ShuffleCombine method:<br/>
/// (c) Daniel Lemire, Geoff Langdale, animetosho<br/>
/// MIT and Apache 2.0 Licenses.
/// </summary>
internal static unsafe class CompressionTables
{
    // @formatter:off
    /// <summary>
    /// LUT for compressing a 256bit byte vector.
    /// </summary>
    // csharpier-ignore
    public static ReadOnlySpan<ulong> ThinEpi8 => [
        0x0706050403020100, 0x0007060504030201, /**/ 0x0007060504030200, 0x0000070605040302,
        0x0007060504030100, 0x0000070605040301, /**/ 0x0000070605040300, 0x0000000706050403,
        0x0007060504020100, 0x0000070605040201, /**/ 0x0000070605040200, 0x0000000706050402,
        0x0000070605040100, 0x0000000706050401, /**/ 0x0000000706050400, 0x0000000007060504,
        0x0007060503020100, 0x0000070605030201, /**/ 0x0000070605030200, 0x0000000706050302,
        0x0000070605030100, 0x0000000706050301, /**/ 0x0000000706050300, 0x0000000007060503,
        0x0000070605020100, 0x0000000706050201, /**/ 0x0000000706050200, 0x0000000007060502,
        0x0000000706050100, 0x0000000007060501, /**/ 0x0000000007060500, 0x0000000000070605,
        0x0007060403020100, 0x0000070604030201, /**/ 0x0000070604030200, 0x0000000706040302,
        0x0000070604030100, 0x0000000706040301, /**/ 0x0000000706040300, 0x0000000007060403,
        0x0000070604020100, 0x0000000706040201, /**/ 0x0000000706040200, 0x0000000007060402,
        0x0000000706040100, 0x0000000007060401, /**/ 0x0000000007060400, 0x0000000000070604,
        0x0000070603020100, 0x0000000706030201, /**/ 0x0000000706030200, 0x0000000007060302,
        0x0000000706030100, 0x0000000007060301, /**/ 0x0000000007060300, 0x0000000000070603,
        0x0000000706020100, 0x0000000007060201, /**/ 0x0000000007060200, 0x0000000000070602,
        0x0000000007060100, 0x0000000000070601, /**/ 0x0000000000070600, 0x0000000000000706,
        0x0007050403020100, 0x0000070504030201, /**/ 0x0000070504030200, 0x0000000705040302,
        0x0000070504030100, 0x0000000705040301, /**/ 0x0000000705040300, 0x0000000007050403,
        0x0000070504020100, 0x0000000705040201, /**/ 0x0000000705040200, 0x0000000007050402,
        0x0000000705040100, 0x0000000007050401, /**/ 0x0000000007050400, 0x0000000000070504,
        0x0000070503020100, 0x0000000705030201, /**/ 0x0000000705030200, 0x0000000007050302,
        0x0000000705030100, 0x0000000007050301, /**/ 0x0000000007050300, 0x0000000000070503,
        0x0000000705020100, 0x0000000007050201, /**/ 0x0000000007050200, 0x0000000000070502,
        0x0000000007050100, 0x0000000000070501, /**/ 0x0000000000070500, 0x0000000000000705,
        0x0000070403020100, 0x0000000704030201, /**/ 0x0000000704030200, 0x0000000007040302,
        0x0000000704030100, 0x0000000007040301, /**/ 0x0000000007040300, 0x0000000000070403,
        0x0000000704020100, 0x0000000007040201, /**/ 0x0000000007040200, 0x0000000000070402,
        0x0000000007040100, 0x0000000000070401, /**/ 0x0000000000070400, 0x0000000000000704,
        0x0000000703020100, 0x0000000007030201, /**/ 0x0000000007030200, 0x0000000000070302,
        0x0000000007030100, 0x0000000000070301, /**/ 0x0000000000070300, 0x0000000000000703,
        0x0000000007020100, 0x0000000000070201, /**/ 0x0000000000070200, 0x0000000000000702,
        0x0000000000070100, 0x0000000000000701, /**/ 0x0000000000000700, 0x0000000000000007,
        0x0006050403020100, 0x0000060504030201, /**/ 0x0000060504030200, 0x0000000605040302,
        0x0000060504030100, 0x0000000605040301, /**/ 0x0000000605040300, 0x0000000006050403,
        0x0000060504020100, 0x0000000605040201, /**/ 0x0000000605040200, 0x0000000006050402,
        0x0000000605040100, 0x0000000006050401, /**/ 0x0000000006050400, 0x0000000000060504,
        0x0000060503020100, 0x0000000605030201, /**/ 0x0000000605030200, 0x0000000006050302,
        0x0000000605030100, 0x0000000006050301, /**/ 0x0000000006050300, 0x0000000000060503,
        0x0000000605020100, 0x0000000006050201, /**/ 0x0000000006050200, 0x0000000000060502,
        0x0000000006050100, 0x0000000000060501, /**/ 0x0000000000060500, 0x0000000000000605,
        0x0000060403020100, 0x0000000604030201, /**/ 0x0000000604030200, 0x0000000006040302,
        0x0000000604030100, 0x0000000006040301, /**/ 0x0000000006040300, 0x0000000000060403,
        0x0000000604020100, 0x0000000006040201, /**/ 0x0000000006040200, 0x0000000000060402,
        0x0000000006040100, 0x0000000000060401, /**/ 0x0000000000060400, 0x0000000000000604,
        0x0000000603020100, 0x0000000006030201, /**/ 0x0000000006030200, 0x0000000000060302,
        0x0000000006030100, 0x0000000000060301, /**/ 0x0000000000060300, 0x0000000000000603,
        0x0000000006020100, 0x0000000000060201, /**/ 0x0000000000060200, 0x0000000000000602,
        0x0000000000060100, 0x0000000000000601, /**/ 0x0000000000000600, 0x0000000000000006,
        0x0000050403020100, 0x0000000504030201, /**/ 0x0000000504030200, 0x0000000005040302,
        0x0000000504030100, 0x0000000005040301, /**/ 0x0000000005040300, 0x0000000000050403,
        0x0000000504020100, 0x0000000005040201, /**/ 0x0000000005040200, 0x0000000000050402,
        0x0000000005040100, 0x0000000000050401, /**/ 0x0000000000050400, 0x0000000000000504,
        0x0000000503020100, 0x0000000005030201, /**/ 0x0000000005030200, 0x0000000000050302,
        0x0000000005030100, 0x0000000000050301, /**/ 0x0000000000050300, 0x0000000000000503,
        0x0000000005020100, 0x0000000000050201, /**/ 0x0000000000050200, 0x0000000000000502,
        0x0000000000050100, 0x0000000000000501, /**/ 0x0000000000000500, 0x0000000000000005,
        0x0000000403020100, 0x0000000004030201, /**/ 0x0000000004030200, 0x0000000000040302,
        0x0000000004030100, 0x0000000000040301, /**/ 0x0000000000040300, 0x0000000000000403,
        0x0000000004020100, 0x0000000000040201, /**/ 0x0000000000040200, 0x0000000000000402,
        0x0000000000040100, 0x0000000000000401, /**/ 0x0000000000000400, 0x0000000000000004,
        0x0000000003020100, 0x0000000000030201, /**/ 0x0000000000030200, 0x0000000000000302,
        0x0000000000030100, 0x0000000000000301, /**/ 0x0000000000000300, 0x0000000000000003,
        0x0000000000020100, 0x0000000000000201, /**/ 0x0000000000000200, 0x0000000000000002,
        0x0000000000000100, 0x0000000000000001, /**/ 0x0000000000000000, 0x0000000000000000,
    ];

    // csharpier-ignore
    public static ReadOnlySpan<ulong> ThinEpiHi8 => [
        0x0f0e0d0c0b0a0908, 0x080f0e0d0c0b0a09, /**/ 0x080f0e0d0c0b0a08, 0x08080f0e0d0c0b0a,
        0x080f0e0d0c0b0908, 0x08080f0e0d0c0b09, /**/ 0x08080f0e0d0c0b08, 0x0808080f0e0d0c0b,
        0x080f0e0d0c0a0908, 0x08080f0e0d0c0a09, /**/ 0x08080f0e0d0c0a08, 0x0808080f0e0d0c0a,
        0x08080f0e0d0c0908, 0x0808080f0e0d0c09, /**/ 0x0808080f0e0d0c08, 0x080808080f0e0d0c,
        0x080f0e0d0b0a0908, 0x08080f0e0d0b0a09, /**/ 0x08080f0e0d0b0a08, 0x0808080f0e0d0b0a,
        0x08080f0e0d0b0908, 0x0808080f0e0d0b09, /**/ 0x0808080f0e0d0b08, 0x080808080f0e0d0b,
        0x08080f0e0d0a0908, 0x0808080f0e0d0a09, /**/ 0x0808080f0e0d0a08, 0x080808080f0e0d0a,
        0x0808080f0e0d0908, 0x080808080f0e0d09, /**/ 0x080808080f0e0d08, 0x08080808080f0e0d,
        0x080f0e0c0b0a0908, 0x08080f0e0c0b0a09, /**/ 0x08080f0e0c0b0a08, 0x0808080f0e0c0b0a,
        0x08080f0e0c0b0908, 0x0808080f0e0c0b09, /**/ 0x0808080f0e0c0b08, 0x080808080f0e0c0b,
        0x08080f0e0c0a0908, 0x0808080f0e0c0a09, /**/ 0x0808080f0e0c0a08, 0x080808080f0e0c0a,
        0x0808080f0e0c0908, 0x080808080f0e0c09, /**/ 0x080808080f0e0c08, 0x08080808080f0e0c,
        0x08080f0e0b0a0908, 0x0808080f0e0b0a09, /**/ 0x0808080f0e0b0a08, 0x080808080f0e0b0a,
        0x0808080f0e0b0908, 0x080808080f0e0b09, /**/ 0x080808080f0e0b08, 0x08080808080f0e0b,
        0x0808080f0e0a0908, 0x080808080f0e0a09, /**/ 0x080808080f0e0a08, 0x08080808080f0e0a,
        0x080808080f0e0908, 0x08080808080f0e09, /**/ 0x08080808080f0e08, 0x0808080808080f0e,
        0x080f0d0c0b0a0908, 0x08080f0d0c0b0a09, /**/ 0x08080f0d0c0b0a08, 0x0808080f0d0c0b0a,
        0x08080f0d0c0b0908, 0x0808080f0d0c0b09, /**/ 0x0808080f0d0c0b08, 0x080808080f0d0c0b,
        0x08080f0d0c0a0908, 0x0808080f0d0c0a09, /**/ 0x0808080f0d0c0a08, 0x080808080f0d0c0a,
        0x0808080f0d0c0908, 0x080808080f0d0c09, /**/ 0x080808080f0d0c08, 0x08080808080f0d0c,
        0x08080f0d0b0a0908, 0x0808080f0d0b0a09, /**/ 0x0808080f0d0b0a08, 0x080808080f0d0b0a,
        0x0808080f0d0b0908, 0x080808080f0d0b09, /**/ 0x080808080f0d0b08, 0x08080808080f0d0b,
        0x0808080f0d0a0908, 0x080808080f0d0a09, /**/ 0x080808080f0d0a08, 0x08080808080f0d0a,
        0x080808080f0d0908, 0x08080808080f0d09, /**/ 0x08080808080f0d08, 0x0808080808080f0d,
        0x08080f0c0b0a0908, 0x0808080f0c0b0a09, /**/ 0x0808080f0c0b0a08, 0x080808080f0c0b0a,
        0x0808080f0c0b0908, 0x080808080f0c0b09, /**/ 0x080808080f0c0b08, 0x08080808080f0c0b,
        0x0808080f0c0a0908, 0x080808080f0c0a09, /**/ 0x080808080f0c0a08, 0x08080808080f0c0a,
        0x080808080f0c0908, 0x08080808080f0c09, /**/ 0x08080808080f0c08, 0x0808080808080f0c,
        0x0808080f0b0a0908, 0x080808080f0b0a09, /**/ 0x080808080f0b0a08, 0x08080808080f0b0a,
        0x080808080f0b0908, 0x08080808080f0b09, /**/ 0x08080808080f0b08, 0x0808080808080f0b,
        0x080808080f0a0908, 0x08080808080f0a09, /**/ 0x08080808080f0a08, 0x0808080808080f0a,
        0x08080808080f0908, 0x0808080808080f09, /**/ 0x0808080808080f08, 0x080808080808080f,
        0x080e0d0c0b0a0908, 0x08080e0d0c0b0a09, /**/ 0x08080e0d0c0b0a08, 0x0808080e0d0c0b0a,
        0x08080e0d0c0b0908, 0x0808080e0d0c0b09, /**/ 0x0808080e0d0c0b08, 0x080808080e0d0c0b,
        0x08080e0d0c0a0908, 0x0808080e0d0c0a09, /**/ 0x0808080e0d0c0a08, 0x080808080e0d0c0a,
        0x0808080e0d0c0908, 0x080808080e0d0c09, /**/ 0x080808080e0d0c08, 0x08080808080e0d0c,
        0x08080e0d0b0a0908, 0x0808080e0d0b0a09, /**/ 0x0808080e0d0b0a08, 0x080808080e0d0b0a,
        0x0808080e0d0b0908, 0x080808080e0d0b09, /**/ 0x080808080e0d0b08, 0x08080808080e0d0b,
        0x0808080e0d0a0908, 0x080808080e0d0a09, /**/ 0x080808080e0d0a08, 0x08080808080e0d0a,
        0x080808080e0d0908, 0x08080808080e0d09, /**/ 0x08080808080e0d08, 0x0808080808080e0d,
        0x08080e0c0b0a0908, 0x0808080e0c0b0a09, /**/ 0x0808080e0c0b0a08, 0x080808080e0c0b0a,
        0x0808080e0c0b0908, 0x080808080e0c0b09, /**/ 0x080808080e0c0b08, 0x08080808080e0c0b,
        0x0808080e0c0a0908, 0x080808080e0c0a09, /**/ 0x080808080e0c0a08, 0x08080808080e0c0a,
        0x080808080e0c0908, 0x08080808080e0c09, /**/ 0x08080808080e0c08, 0x0808080808080e0c,
        0x0808080e0b0a0908, 0x080808080e0b0a09, /**/ 0x080808080e0b0a08, 0x08080808080e0b0a,
        0x080808080e0b0908, 0x08080808080e0b09, /**/ 0x08080808080e0b08, 0x0808080808080e0b,
        0x080808080e0a0908, 0x08080808080e0a09, /**/ 0x08080808080e0a08, 0x0808080808080e0a,
        0x08080808080e0908, 0x0808080808080e09, /**/ 0x0808080808080e08, 0x080808080808080e,
        0x08080d0c0b0a0908, 0x0808080d0c0b0a09, /**/ 0x0808080d0c0b0a08, 0x080808080d0c0b0a,
        0x0808080d0c0b0908, 0x080808080d0c0b09, /**/ 0x080808080d0c0b08, 0x08080808080d0c0b,
        0x0808080d0c0a0908, 0x080808080d0c0a09, /**/ 0x080808080d0c0a08, 0x08080808080d0c0a,
        0x080808080d0c0908, 0x08080808080d0c09, /**/ 0x08080808080d0c08, 0x0808080808080d0c,
        0x0808080d0b0a0908, 0x080808080d0b0a09, /**/ 0x080808080d0b0a08, 0x08080808080d0b0a,
        0x080808080d0b0908, 0x08080808080d0b09, /**/ 0x08080808080d0b08, 0x0808080808080d0b,
        0x080808080d0a0908, 0x08080808080d0a09, /**/ 0x08080808080d0a08, 0x0808080808080d0a,
        0x08080808080d0908, 0x0808080808080d09, /**/ 0x0808080808080d08, 0x080808080808080d,
        0x0808080c0b0a0908, 0x080808080c0b0a09, /**/ 0x080808080c0b0a08, 0x08080808080c0b0a,
        0x080808080c0b0908, 0x08080808080c0b09, /**/ 0x08080808080c0b08, 0x0808080808080c0b,
        0x080808080c0a0908, 0x08080808080c0a09, /**/ 0x08080808080c0a08, 0x0808080808080c0a,
        0x08080808080c0908, 0x0808080808080c09, /**/ 0x0808080808080c08, 0x080808080808080c,
        0x080808080b0a0908, 0x08080808080b0a09, /**/ 0x08080808080b0a08, 0x0808080808080b0a,
        0x08080808080b0908, 0x0808080808080b09, /**/ 0x0808080808080b08, 0x080808080808080b,
        0x08080808080a0908, 0x0808080808080a09, /**/ 0x0808080808080a08, 0x080808080808080a,
        0x0808080808080908, 0x0808080808080809, /**/ 0x0808080808080808, 0x0808080808080808,
    ];

    /// <summary>
    /// LUT to arrange lower and upper lanes of a  128bit vector.
    /// </summary>
    /// <remarks>
    /// Offset by 16 bytes so the upper lane can be blended correctly later.
    /// </remarks>
    // csharpier-ignore
    public static ReadOnlySpan<byte> ShuffleCombine => [
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // ^ first lane is empty so we can offset the upper lane properly for later blend
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF,
        0x00, 0x01, 0x02, 0x03, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x01, 0x02, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x01, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ];

    /// <summary>
    /// LUT for <c>popcnt(v) * 2</c>.
    /// </summary>
    // csharpier-ignore
    public static ReadOnlySpan<byte> PopCountMult2 => [
        0,  2,  2,  4,  2,  4,  4,  6,  2,  4,  4,  6,  4,  6,  6,  8,  2,  4,  4,
        6,  4,  6,  6,  8,  4,  6,  6,  8,  6,  8,  8,  10, 2,  4,  4,  6,  4,  6,
        6,  8,  4,  6,  6,  8,  6,  8,  8,  10, 4,  6,  6,  8,  6,  8,  8,  10, 6,
        8,  8,  10, 8,  10, 10, 12, 2,  4,  4,  6,  4,  6,  6,  8,  4,  6,  6,  8,
        6,  8,  8,  10, 4,  6,  6,  8,  6,  8,  8,  10, 6,  8,  8,  10, 8,  10, 10,
        12, 4,  6,  6,  8,  6,  8,  8,  10, 6,  8,  8,  10, 8,  10, 10, 12, 6,  8,
        8,  10, 8,  10, 10, 12, 8,  10, 10, 12, 10, 12, 12, 14, 2,  4,  4,  6,  4,
        6,  6,  8,  4,  6,  6,  8,  6,  8,  8,  10, 4,  6,  6,  8,  6,  8,  8,  10,
        6,  8,  8,  10, 8,  10, 10, 12, 4,  6,  6,  8,  6,  8,  8,  10, 6,  8,  8,
        10, 8,  10, 10, 12, 6,  8,  8,  10, 8,  10, 10, 12, 8,  10, 10, 12, 10, 12,
        12, 14, 4,  6,  6,  8,  6,  8,  8,  10, 6,  8,  8,  10, 8,  10, 10, 12, 6,
        8,  8,  10, 8,  10, 10, 12, 8,  10, 10, 12, 10, 12, 12, 14, 6,  8,  8,  10,
        8,  10, 10, 12, 8,  10, 10, 12, 10, 12, 12, 14, 8,  10, 10, 12, 10, 12, 12,
        14, 10, 12, 12, 14, 12, 14, 14, 16
    ];

    // csharpier-ignore
    public static ReadOnlySpan<byte> PopCount => [
        0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4,
        1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5,
        1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7,
        1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7,
        2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6,
        3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7,
        3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7,
        4, 5, 5, 6, 5, 6, 6, 7, 5, 6, 6, 7, 6, 7, 7, 8
    ];

    internal static readonly byte* BlendMask;

    /// <summary>
    /// Loads the blend mask for the specified lower lane offset.
    /// </summary>
    /// <param name="lowerLaneOffset">Number of items that should be picked from the lower lane.</param>
    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    public static Vector128<byte> LoadBlendMask(uint lowerLaneOffset)
    {
        Check.LessThanOrEqual(lowerLaneOffset, 15u);
        return Vector128.LoadAligned(BlendMask + (lowerLaneOffset * Vector128<byte>.Count));
    }

    static CompressionTables()
    {
        // csharpier-ignore
        var blendMaskArray = new byte[]
        {
            0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80, 0x80,
               0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 0x80,
        };
        Check.Equal(blendMaskArray.Length, 256);

        BlendMask = (byte*)NativeMemory.AlignedAlloc(byteCount: 256, alignment: 16);
        blendMaskArray.CopyTo(new Span<byte>(BlendMask, 256));
    }
}
